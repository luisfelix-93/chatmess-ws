name: Auto PR on Push

on:
  push:
    branches:
      - '*'  # Monitora todas as branches (exceto tags)

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v3

      - name: Criar Pull Request automaticamente
        uses: actions/github-script@v6
        with:
          script: |
            const github = require('@actions/github');
            const context = github.context; // ðŸ’¡ Certifica-se de que 'context' estÃ¡ acessÃ­vel

            // ObtÃ©m a referÃªncia do evento
            const ref = process.env.GITHUB_REF;
            console.log(`ReferÃªncia do push: ${ref}`);

            // Garante que estamos lidando com uma branch e nÃ£o uma tag
            if (!ref.startsWith("refs/heads/")) {
              console.log("Este push nÃ£o foi para uma branch. PR nÃ£o serÃ¡ criado.");
              return;
            }

            // Extrai o nome da branch
            const branch = ref.replace("refs/heads/", "");
            console.log(`Branch detectada: ${branch}`);

            // Define a branch base do PR (altere se necessÃ¡rio)
            const baseBranch = "v1";
            if (branch === baseBranch) {
              console.log(`Push na branch '${baseBranch}', PR nÃ£o serÃ¡ criado.`);
              return;
            }

            // Verifica se jÃ¡ existe um PR aberto para essa branch
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${branch}`, // ðŸ”¹ Removendo `${context.repo.owner}:` para evitar conflitos
              base: baseBranch,
              state: "open"
            });

            if (existingPRs.data.length > 0) {
              console.log(`JÃ¡ existe um PR aberto para a branch '${branch}'.`);
              return;
            }

            // Criando um novo Pull Request
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: branch,
              base: baseBranch,
              title: `Auto PR: ${branch} â†’ ${baseBranch}`,
              body: `Este PR foi criado automaticamente a partir de um push para a branch \`${branch}\`.`
            });

            console.log(`âœ… PR criado com sucesso: ${pr.data.html_url}`);
